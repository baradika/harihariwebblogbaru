---
import { Image } from 'astro:assets';
import MainLayout from '../layouts/MainLayout.astro';
import Prose from '../components/core/Prose.astro';
import Projects from '../components/Projects.astro';
import MusicPresence from '../components/activity/MusicPresence.astro';
import Card from '../components/core/Card.astro';
// import Experience from "../components/Experience.astro";
import { getCollection } from 'astro:content';

// Only query notes collection to avoid warnings about empty/non-existent writeups collection
const notes = await getCollection('notes', (e) => !e.data.draft);

function byDateDesc(a: any, b: any) {
  const ad = a?.data?.date ? new Date(a.data.date).getTime() : 0;
  const bd = b?.data?.date ? new Date(b.data.date).getTime() : 0;
  if (bd !== ad) return bd - ad;
  // Fallback to slug lexical (so 2025/... > 2024/...)
  const as = String(a.slug || '');
  const bs = String(b.slug || '');
  return bs.localeCompare(as);
}

const latestNotes = notes.sort(byDateDesc).slice(0, 1);
const latestNote = latestNotes[0];

// Safe fallback for Notes to avoid /notes/undefined
const fallbackNoteSlug = 'godot-game-hack';
const fallbackNoteTitleMap: Record<string, string> = {
  'godot-game-hack': 'Godot Game Reverse Engineering with GDRE',
};
const latestNoteOrFallback = latestNote ?? {
  slug: fallbackNoteSlug,
  data: {
    title: fallbackNoteTitleMap[fallbackNoteSlug] ?? 'Latest Note',
    date: new Date(),
    description: ''
  }
};

function fmt(d: Date) {
  try {
    return new Date(d).toLocaleDateString('en-US', {
      year: 'numeric', month: 'short', day: '2-digit'
    });
  } catch {
    return '';
  }
}

const fallbackWriteupSlug = '2025/compfest17quals';
const fallbackWriteupTitleMap: Record<string, string> = {
  '2025/compfest17quals': 'COMPFEST 17 Quals',
};

// Fallback writeup (pages-based) to avoid querying an empty collection
const latestWriteup = {
  slug: fallbackWriteupSlug,
  data: {
    title: fallbackWriteupTitleMap[fallbackWriteupSlug] ?? 'Latest Writeup',
    date: new Date(),
    description: ''
  }
};
---

<MainLayout title="Home">
  <Prose>
    <h1 class="font-medium">
      <span class="block overflow-hidden group relative">
        <span
          class="inline-block duration-300 ease-in-out group-hover:-translate-y-full"
        >
          b4r
        </span>
        <span
          class="inline-block absolute left-0 top-0 duration-300 ease-in-out translate-y-full group-hover:translate-y-0"
        >
          Fase Rais Baradika
        </span>
      </span>
    </h1>
    <p>
      I'm a full-stack web developer and dedicated <a
        target="_blank"
        href="https://ctftime.org/user/216423"
        class="not-prose bg-flexoki-base-50 dark:bg-flexoki-base-950 text-xs font-medium px-2.5 py-0.5 rounded"
        ><Image
          src="https://avatars.githubusercontent.com/u/2167643?v=4"
          alt="CTFTime"
          width={8}
          height={8}
          loading="eager"
          class="inline-block mr-1"
        />CTF</a
      > player. I actively participate in a Capture The Flag (CTF) competitions,
      where I sharpen my skills in cybersecurity, <a
        href="#"
        class="not-prose bg-flexoki-base-50 dark:bg-flexoki-base-950 text-xs font-medium px-2.5 py-0.5 rounded"
        ><Image
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Ghidra_logo.svg/2048px-Ghidra_logo.svg.png"
          alt="Reverse Engineering"
          width={8}
          height={8}
          loading="eager"
          class="inline-block mr-1"
        />Reverse Engineering</a
      > <a
        href="#"
        class="not-prose bg-flexoki-base-50 dark:bg-flexoki-base-950 text-xs font-medium px-2.5 py-0.5 rounded"
        ><Image
          src="https://upload.wikimedia.org/wikipedia/commons/c/c6/Wireshark_icon_new.png"
          alt="DFIR"
          width={8}
          height={8}
          loading="eager"
          class="inline-block mr-1"
        />DFIR</a
      >and  <a
        href="#"
        class="not-prose bg-flexoki-base-50 dark:bg-flexoki-base-950 text-xs font-medium px-2.5 py-0.5 rounded"
        ><Image
          src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/ethereum.svg"
          alt="Blockchain"
          width={8}
          height={8}
          loading="eager"
          class="inline-block mr-1 dark:invert"
        />Blockchain</a
    </p>

    <div class="not-prose flex flex-col md:flex-row gap-1 mt-4">
      <MusicPresence />
      <Card class="rounded-none rounded-b md:rounded-none md:rounded-r !bg-transparent !border-0">
        <div slot="content" class="text-xs md:w-42">
          TODO: Add Experiences, Awards, Gym Time, Discord, Github, and more
          here (because someone said my website too simple).
        </div>
      </Card>
    </div>

    <h2 class="font-medium mt-8">Latest Posts</h2>
    <div class="not-prose grid gap-8 grid-cols-1">
      <section>
        <h3 class="font-medium mb-2">Writeups</h3>
        <a class="block p-3 rounded border border-flexoki-base-100 dark:border-flexoki-base-900 hover:bg-flexoki-base-50/50 dark:hover:bg-flexoki-base-950/50 transition" href={`/writeups/${latestWriteup.slug}`}>
          <div class="font-medium">{latestWriteup.data.title}</div>
          {latestWriteup.data.description && <div class="text-sm mt-1">{latestWriteup.data.description}</div>}
        </a>
      </section>

      <section>
        <h3 class="font-medium mb-2">Notes</h3>
        <a class="block p-3 rounded border border-flexoki-base-100 dark:border-flexoki-base-900 hover:bg-flexoki-base-50/50 dark:hover:bg-flexoki-base-950/50 transition" href={`/notes/${latestNoteOrFallback.slug}`}>
          <div class="font-medium">{latestNoteOrFallback.data.title}</div>
          {latestNoteOrFallback.data.description && <div class="text-sm mt-1">{latestNoteOrFallback.data.description}</div>}
        </a>
      </section>
    </div>

    <!-- <p>
        I also have <a
          target="_blank"
          href=`quartz.${Astro.url.host}`
          class="not-prose bg-flexoki-base-50 dark:bg-flexoki-base-950 text-xs font-medium px-2.5 py-0.5 rounded"
          >ðŸ¥¬ Digital Garden</a
        > for CTF notes and other notes.
      </p>
      <h2 class="font-medium">Experiences</h2>
      <div class="not-prose">
        <Experience />
      </div> -->
  </Prose>
</MainLayout>
